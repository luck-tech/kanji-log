# å¹¹äº‹ãƒŠãƒ“ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºç”¨ Makefile
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: å¹¹äº‹ãƒŠãƒ“ï¼ˆKanji Naviï¼‰
# ä½œæˆæ—¥: 2025å¹´9æœˆ4æ—¥
# 
# ä½¿ç”¨ä¾‹:
#   make build lambda=hello
#   make deploy
#   make dev-deploy lambda=hello
#   make clean

.PHONY: help init build deploy deploy-auto test clean list-functions dev-deploy test-api update-deps

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
help:
	@echo "ğŸµ å¹¹äº‹ãƒŠãƒ“ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚³ãƒãƒ³ãƒ‰"
	@echo ""
	@echo "ğŸ“– ä½¿ç”¨æ–¹æ³•:"
	@echo "  make build lambda=<function-name>  # Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make deploy                        # Terraformã§ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰"
	@echo "  make deploy-auto                   # Terraformã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¢ºèªãªã—ï¼‰"
	@echo "  make dev-deploy lambda=<function>  # ãƒ“ãƒ«ãƒ‰ + è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make test                          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo "  make test-api                      # APIå‹•ä½œç¢ºèª"
	@echo "  make clean                         # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤"
	@echo "  make list-functions                # åˆ©ç”¨å¯èƒ½ãªé–¢æ•°ä¸€è¦§"
	@echo "  make init                          # Goä¾å­˜é–¢ä¿‚ã®åˆæœŸåŒ–"
	@echo "  make update-deps                   # ä¾å­˜é–¢ä¿‚ã®æ›´æ–°"
	@echo ""
	@echo "ğŸ’¡ ä¾‹:"
	@echo "  make build lambda=hello"
	@echo "  make build lambda=create-event"
	@echo "  make dev-deploy lambda=hello"

# Goä¾å­˜é–¢ä¿‚ã®åˆæœŸåŒ–
init:
	@echo "ğŸ”§ Goä¾å­˜é–¢ä¿‚ã‚’åˆæœŸåŒ–ä¸­..."
	@go mod tidy
	@echo "âœ… åˆæœŸåŒ–å®Œäº†"

# Lambdaé–¢æ•°ã®ãƒ“ãƒ«ãƒ‰
build:
ifndef lambda
	@echo "âŒ ã‚¨ãƒ©ãƒ¼: lambda ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™"
	@echo "ä½¿ç”¨ä¾‹: make build lambda=hello"
	@echo ""
	@make list-functions
	@exit 1
endif
	@echo "ğŸ—ï¸  Lambdaé–¢æ•°ã‚’ãƒ“ãƒ«ãƒ‰ä¸­: $(lambda)"
	@./scripts/build.sh $(lambda)
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†: $(lambda)-lambda.zip"

# Terraformãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰
deploy:
	@echo "ğŸš€ Terraformã§ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	@echo "ğŸ“‹ å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¾ã™..."
	@cd ../iac/environments/dev && terraform plan -out=tfplan
	@echo ""
	@echo "â“ ä¸Šè¨˜ã®å¤‰æ›´å†…å®¹ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã‹? [y/N]: "; \
	read -r answer; \
	if [ "$$answer" = "y" ] || [ "$$answer" = "Y" ]; then \
		cd ../iac/environments/dev && terraform apply tfplan && \
		echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"; \
	else \
		echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
		cd ../iac/environments/dev && rm -f tfplan; \
	fi

# è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¢ºèªãªã—ï¼‰
deploy-auto:
	@echo "ğŸš€ Terraformã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	@cd ../iac/environments/dev && terraform apply -auto-approve
	@echo "âœ… è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
test:
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	@go test ./... -v
	@echo "âœ… ãƒ†ã‚¹ãƒˆå®Œäº†"

# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®å‰Šé™¤
clean:
	@echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤ä¸­..."
	@rm -rf build/
	@rm -f *-lambda.zip
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# åˆ©ç”¨å¯èƒ½ãªé–¢æ•°ä¸€è¦§
list-functions:
	@echo "ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªLambdaé–¢æ•°:"
	@if [ -d "cmd/api" ]; then \
		find cmd/api -name "main.go" -exec dirname {} \; | sed 's|cmd/api/||' | sort | sed 's/^/  - /'; \
	else \
		echo "  (cmd/api ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)"; \
	fi

# é–‹ç™ºç”¨: ãƒ“ãƒ«ãƒ‰ + ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä¸€æ‹¬å®Ÿè¡Œ
dev-deploy:
ifndef lambda
	@echo "âŒ ã‚¨ãƒ©ãƒ¼: lambda ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™"
	@echo "ä½¿ç”¨ä¾‹: make dev-deploy lambda=hello"
	@echo ""
	@make list-functions
	@exit 1
endif
	@echo "ğŸš€ é–‹ç™ºãƒ‡ãƒ—ãƒ­ã‚¤: $(lambda) ã‚’ãƒ“ãƒ«ãƒ‰ + ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™"
	@make build lambda=$(lambda)
	@make deploy-auto

# APIå‹•ä½œç¢ºèª
test-api:
	@echo "ğŸ” Hello APIå‹•ä½œç¢ºèªä¸­..."
	@if command -v jq >/dev/null 2>&1; then \
		curl -s https://sepimmk54m.execute-api.ap-northeast-1.amazonaws.com/dev/hello | jq .; \
	else \
		curl -s https://sepimmk54m.execute-api.ap-northeast-1.amazonaws.com/dev/hello; \
	fi
	@echo ""
	@echo "âœ… APIå‹•ä½œç¢ºèªå®Œäº†"

# ä¾å­˜é–¢ä¿‚ã®æ›´æ–°
update-deps:
	@echo "ğŸ“¦ Goä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ä¸­..."
	@go get -u ./...
	@go mod tidy
	@echo "âœ… ä¾å­˜é–¢ä¿‚æ›´æ–°å®Œäº†"

# é–‹ç™ºæƒ…å ±è¡¨ç¤º
info:
	@echo "ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±:"
	@echo "  - Goãƒãƒ¼ã‚¸ãƒ§ãƒ³: $$(go version)"
	@echo "  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹: $$(pwd)"
	@echo "  - Git ãƒ–ãƒ©ãƒ³ãƒ: $$(git branch --show-current 2>/dev/null || echo 'GitæœªåˆæœŸåŒ–')"
	@echo ""
	@make list-functions

# ãƒ­ã‚°ç¢ºèªï¼ˆCloudWatch Logsï¼‰
logs:
ifndef lambda
	@echo "âŒ ã‚¨ãƒ©ãƒ¼: lambda ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™"
	@echo "ä½¿ç”¨ä¾‹: make logs lambda=hello"
	@exit 1
endif
	@echo "ğŸ“„ CloudWatch Logs ã‚’ç¢ºèªä¸­: kanji-log-$(lambda)-dev"
	@aws logs tail /aws/lambda/kanji-log-$(lambda)-dev --follow
