---
applyTo: "/backend, /iac"
---

## 開発上のセキュリティルール

### 1\. 認証 (Authentication) と認可 (Authorization)

- **認証は Cognito に一任せよ:** 認証ロジックを自前で実装するな。パスワードハッシュ化、トークン管理、MFA、SNS 連携はすべて Cognito の責務とする。
- **API Gateway で認証を強制せよ:** 全ての機密 API エンドポイントは、API Gateway の Cognito オーソライザーで保護し、未認証リクエストは Lambda に到達する前にブロックせよ。
- **認可は Lambda の責務である:** Lambda 関数内では、認証されたユーザー（`sub`）が、操作対象のデータ（例: `eventId`）に対して\*\*何をして良いか（認可）\*\*を必ず検証せよ。「ユーザー A がユーザー B のデータを操作できないか？」を常に問い、コードレベルでチェックせよ。

### 2\. 入力値のバリデーション

- **サーバーサイドで必ず検証せよ:** クライアントからの入力は一切信用するな。API Gateway のモデルバリデーション、および Lambda 関数冒頭で、全ての入力値（パスパラメータ、クエリ、リクエストボディ）の型、形式、範囲を厳密に検証せよ。
- **ゼロトラストでサニタイズせよ:** 全ての入力は攻撃であると仮定し、出力（特に HTML やログ）に含める際は必ずエスケープまたはサニタイズ処理を行え。

### 3\. 権限管理 (IAM)

- **最小権限の原則を徹底せよ:** 各 Lambda 関数にアタッチする IAM Role には、その関数が必要とする最小限の権限のみを付与せよ。例えば、DynamoDB からの読み取りだけが必要なら、`dynamodb:GetItem`権限のみを許可し、`dynamodb:*`のようなワイルドカードは絶対に使用するな。

### 4\. 秘密情報 (Secrets) の管理

- **コードに秘密を埋め込むな:** API キー、データベース認証情報などの秘密情報は、ソースコードや環境変数に直接記述することを禁止する。
- **Secrets Manager を利用せよ:** 全ての秘密情報は AWS Secrets Manager または Parameter Store (SecureString) に格納し、Lambda からは実行時の IAM Role を通じて動的に取得せよ。

###　 5\. 依存関係の管理

- **脆弱性スキャンを義務付けよ:** Go の`go.mod`で管理される外部ライブラリは、サプライチェーン攻撃のリスク源である。GitHub Actions などで Dependabot や Snyk のような脆弱性スキャンツールを CI/CD パイプラインに組み込み、脆弱性が発見された場合はマージをブロックせよ。

### 6\. セキュアコーディング (Go)

- **エラーハンドリングを徹底せよ:** Go のエラーは無視するな。全てのエラーを適切にハンドリングし、予期せぬエラーが発生した場合は、詳細なエラーメッセージをクライアントに返さず、サーバー側でロギングせよ。
- **SQL インジェクション対策:** （今回は DynamoDB のため該当しないが）SQL を扱う場合は、必ずプレースホルダを用いたパラメータ化クエリを使用し、文字列結合で SQL 文を組み立てるな。

---

## ディレクトリ構造

```
kanji-log/
├── backend/                  // 🧠 サーバーサイド（Go）
│   ├── cmd/                  // 実行可能なアプリケーションのエントリーポイント
│   │   ├── api/              // Lambda関数ごとのmain.goを格納
│   │   │   ├── create-event/
│   │   │   └── get-event/
│   │   └── batch/            // バッチ処理用のmain.go
│   ├── internal/             // 内部パッケージ（プロジェクト固有のロジック）
│   │   ├── domain/           // ドメインモデル（Event, Userなど）
│   │   ├── handler/          // Lambdaのハンドラーロジック
│   │   ├── repository/       // データストア（DynamoDB）とのやり取り
│   │   └── config/           // 設定管理
│   ├── pkg/                  // 外部公開可能な汎用ライブラリ（今回は基本使わない）
│   ├── go.mod                // Goモジュール定義
│   └── go.sum                // 依存関係のチェックサム
├── iac/                      // 🏛️ インフラ管理 (IaC)
│   ├── environments/         // 環境ごとの設定
│   │   ├── dev/
│   │   └── prd/
│   ├── modules/              // 再利用可能なインフラコンポーネント
│   │   ├── api_gateway/
│   │   ├── cognito/
│   │   └── lambda/
│   └── main.tf               // (例: Terraformの場合のルート定義)
├── .github/                  // CI/CDワークフロー (GitHub Actions)
│   └── workflows/
│       ├── deploy-backend.yml
│       └── deploy-iac.yml
```
