---
applyTo: "backend,iac"
---

## 開発作業における共通ルール

### コード品質・保守性

- **詳細コメントの必須化**: AWS/インフラに慣れていない方でも理解できるよう、全てのコードに詳細なコメントを追加する
  - リソースの目的・役割の説明
  - 設定値の選択理由
  - 幹事ナビでの具体的な使用場面
  - ベストプラクティスとセキュリティ考慮事項
- **作業ログの記録義務**: 全てのタスク作業は `docs/log/task-{番号}.md` に詳細記録する
  - 実行したコマンド（再現可能な形で）
  - 発生したエラーと解決方法
  - 作成・修正したファイル一覧
  - 動作確認結果
  - 次タスクへの引き継ぎ事項
  - 学習ポイント・気づき

### 開発フロー（Task-002a で改善済み）

- **Makefile コマンドの使用を推奨**: 開発効率向上のため、`backend/Makefile`のコマンドを優先使用する
  ```bash
  # 基本コマンド
  make help                          # ヘルプ表示
  make build lambda=<function-name>  # Lambda関数ビルド
  make deploy                        # Terraformデプロイ（確認あり）
  make dev-deploy lambda=<function>  # ビルド+デプロイ一括実行
  make test-api                      # API動作確認
  make clean                         # ビルド成果物削除
  ```
- **汎用ビルドスクリプトの活用**: `./scripts/build.sh <function-name>`で任意の関数をビルド可能
- **エラーハンドリングの活用**: 引数不足や関数未存在時の適切なエラーメッセージを確認する

## 開発上のセキュリティルール

### 1\. 認証 (Authentication) と認可 (Authorization)

- **認証は Cognito に一任せよ:** 認証ロジックを自前で実装するな。パスワードハッシュ化、トークン管理、MFA、SNS 連携はすべて Cognito の責務とする。
- **API Gateway で認証を強制せよ:** 全ての機密 API エンドポイントは、API Gateway の Cognito オーソライザーで保護し、未認証リクエストは Lambda に到達する前にブロックせよ。
- **認可は Lambda の責務である:** Lambda 関数内では、認証されたユーザー（`sub`）が、操作対象のデータ（例: `eventId`）に対して\*\*何をして良いか（認可）\*\*を必ず検証せよ。「ユーザー A がユーザー B のデータを操作できないか？」を常に問い、コードレベルでチェックせよ。

### 2\. 入力値のバリデーション

- **サーバーサイドで必ず検証せよ:** クライアントからの入力は一切信用するな。API Gateway のモデルバリデーション、および Lambda 関数冒頭で、全ての入力値（パスパラメータ、クエリ、リクエストボディ）の型、形式、範囲を厳密に検証せよ。
- **ゼロトラストでサニタイズせよ:** 全ての入力は攻撃であると仮定し、出力（特に HTML やログ）に含める際は必ずエスケープまたはサニタイズ処理を行え。

### 3\. 権限管理 (IAM)

- **最小権限の原則を徹底せよ:** 各 Lambda 関数にアタッチする IAM Role には、その関数が必要とする最小限の権限のみを付与せよ。例えば、DynamoDB からの読み取りだけが必要なら、`dynamodb:GetItem`権限のみを許可し、`dynamodb:*`のようなワイルドカードは絶対に使用するな。
- **開発用 IAM ユーザーの権限管理:** 開発用 IAM ユーザーには`KanjiNaviTerraformMinimal`ポリシーを適用し、AdministratorAccess は絶対に使用するな。必要最小限の権限（DynamoDB、Lambda、API Gateway、IAM 操作）のみを許可せよ。
- **リージョン制限:** IAM ポリシーには`aws:RequestedRegion`条件を追加し、ap-northeast-1 リージョンでの操作に限定せよ（ただし、IAM はグローバルサービスのため別途考慮が必要）。

### 4\. 秘密情報 (Secrets) の管理

- **コードに秘密を埋め込むな:** API キー、データベース認証情報などの秘密情報は、ソースコードや環境変数に直接記述することを禁止する。
- **Secrets Manager を利用せよ:** 全ての秘密情報は AWS Secrets Manager または Parameter Store (SecureString) に格納し、Lambda からは実行時の IAM Role を通じて動的に取得せよ。

###　 5\. 依存関係の管理

- **脆弱性スキャンを義務付けよ:** Go の`go.mod`で管理される外部ライブラリは、サプライチェーン攻撃のリスク源である。GitHub Actions などで Dependabot や Snyk のような脆弱性スキャンツールを CI/CD パイプラインに組み込み、脆弱性が発見された場合はマージをブロックせよ。

### 6\. セキュアコーディング (Go)

- **エラーハンドリングを徹底せよ:** Go のエラーは無視するな。全てのエラーを適切にハンドリングし、予期せぬエラーが発生した場合は、詳細なエラーメッセージをクライアントに返さず、サーバー側でロギングせよ。
- **SQL インジェクション対策:** （今回は DynamoDB のため該当しないが）SQL を扱う場合は、必ずプレースホルダを用いたパラメータ化クエリを使用し、文字列結合で SQL 文を組み立てるな。

### 7\. インフラストラクチャとしてのコード (IaC)

- **Terraform 状態管理の中央化:** 状態ファイル（.tfstate）は必ず S3 バックエンドで管理し、DynamoDB によるロック機能を有効にせよ。ローカルでの状態管理は禁止する。
- **S3 バックエンドのセキュリティ:** 状態ファイル保存用 S3 バケットには暗号化、バージョニング、パブリックアクセスブロックを必ず設定せよ。
- **環境分離:** 開発環境（dev）と本番環境（prd）は完全に分離し、状態ファイルも別々のキーで管理せよ。
- **インフラ変更の可視化:** terraform plan の実行結果は必ず確認し、意図しないリソースの削除や変更がないことを確認してから apply を実行せよ。

---

## ディレクトリ構造

```
kanji-log/
├── backend/                  // 🧠 サーバーサイド（Go）
│   ├── cmd/                  // 実行可能なアプリケーションのエントリーポイント
│   │   ├── api/              // Lambda関数ごとのmain.goを格納
│   │   │   ├── create-event/
│   │   │   └── get-event/
│   │   └── batch/            // バッチ処理用のmain.go
│   ├── internal/             // 内部パッケージ（プロジェクト固有のロジック）
│   │   ├── domain/           // ドメインモデル（Event, Userなど）
│   │   ├── handler/          // Lambdaのハンドラーロジック
│   │   ├── repository/       // データストア（DynamoDB）とのやり取り
│   │   └── config/           // 設定管理
│   ├── pkg/                  // 外部公開可能な汎用ライブラリ（今回は基本使わない）
│   ├── go.mod                // Goモジュール定義
│   └── go.sum                // 依存関係のチェックサム
├── iac/                      // 🏛️ インフラ管理 (IaC)
│   ├── _bootstrap/           // Terraform状態管理用インフラ
│   │   ├── iam_policies/     // IAM権限管理（最小権限ポリシー）
│   │   └── state_backend/    // S3バックエンド・DynamoDBロック設定
│   ├── environments/         // 環境ごとの設定
│   │   ├── dev/              // 開発環境（S3バックエンド対応済み）
│   │   └── prd/              // 本番環境
│   ├── modules/              // 再利用可能なインフラコンポーネント
│   │   ├── api_gateway/
│   │   ├── cognito/
│   │   ├── dynamodb/
│   │   ├── iam/
│   │   └── lambda/
│   └── README.md             // IaC詳細ドキュメント
├── .github/                  // CI/CDワークフロー (GitHub Actions)
│   └── workflows/
│       ├── deploy-backend.yml
│       └── deploy-iac.yml
```
