# 🚀 幹事ナビ プロジェクト: IaC 基盤構築フェーズ完了報告

### 1. 総括: 達成されたこと

当初の目標であった**「最小限のインフラ基盤構築 (Task-001)」**を達成し、さらにセキュリティレビューを経て、**エンタープライズレベルのセキュリティとチーム開発に対応した堅牢な開発基盤**へと昇華させました。

| 達成項目                   | ステータス  | 詳細                                                                          |
| :------------------------- | :---------: | :---------------------------------------------------------------------------- |
| **IaC によるインフラ構築** | ✅ **完了** | Lambda, API Gateway, DynamoDB の基本構成を Terraform で自動構築。             |
| **IAM 権限の最小化**       | ✅ **完了** | `AdministratorAccess`を排除し、Terraform 実行に必要な最小権限ポリシーを適用。 |
| **状態管理の中央化**       | ✅ **完了** | `.tfstate`を S3 で一元管理し、DynamoDB でロックすることでチーム開発に対応。   |
| **セキュリティ堅牢化**     | ✅ **完了** | S3 バケットの暗号化、バージョニング、パブリックアクセスブロックを実装。       |

---

### 2. フェーズ 1：最初のインフラ構築（骨格）

まず、Terraform を用いて、アプリケーションの骨格となる以下の AWS リソースを構築しました。

- **API Gateway:** 外部からのリクエストを受け付ける玄関。
- **Lambda:** Go のコードが実行されるコンピュートエンジン（この時点では空）。
- **DynamoDB:** イベントデータを保存するデータベース。
- **IAM Role:** Lambda が他の AWS サービスへアクセスするための許可証。

これにより、基本的なサーバーレスアーキテクチャが機能する状態となりましたが、セキュリティとチーム開発の観点で 2 つの大きな課題がありました。

---

### 3. フェーズ 2：セキュリティ改善とチーム開発対応

次に、上記課題を解決するため、2 つの重要な改善を実施しました。

#### ① Terraform の状態管理を中央化

ローカル PC にのみ存在していたインフラの設計図 (`.tfstate`) を、チームで共有可能なセキュアな場所に移行しました。

- **S3 バケット:** 暗号化とバージョニングを有効にし、`.tfstate`を安全に保管する「**設計図保管庫**」として構築。
- **DynamoDB テーブル:** 複数人での同時実行を防ぐための「**ロック機構**」として設置。
- **`terraform init -migrate-state`** を実行し、ローカルの状態を S3 へ安全に移行しました。

#### ② IAM ユーザー権限の最小化

開発ユーザーが持っていた管理者権限 (`AdministratorAccess`) を剥奪し、**最小権限の原則**に則ったカスタムポリシーに置き換えました。

- **カスタムポリシー作成:** Terraform でのインフラ操作に必要な権限（`lambda:CreateFunction`など）のみをリストアップした`KanjiNaviTerraformMinimal`ポリシーを作成。
- **権限の付け替え:** 開発ユーザーから`AdministratorAccess`をデタッチし、自作の最小権限ポリシーをアタッチしました。

---

### 4. フェーズ 3：権限エラーの解決（デバッグと成熟）

最小権限への移行過程で、Terraform の動作に必要な、より細かい権限不足エラーに直面しました。

- **トライ＆エラーによる権限の特定:**
  `terraform plan`の度に発生するエラーメッセージ (`iam:GetRole`, `dynamodb:ListTagsOfResource`等) をヒントに、不足している読み取り権限を特定し、ポリシーに段階的に追加しました。

- **根本原因の解決:**
  IAM が**グローバルサービス**であるため、リージョンを限定する`Condition`が原因でエラーが再発していることを突き止めました。IAM 関連の権限を`Condition`のない別の`Statement`に分離することで、問題を完全に解決しました。

このデバッグプロセスを通じて、IAM ポリシーは**実用レベルで洗練された、真の最小権限状態**へと成熟しました。

---

### 5. 最終的な成果と次のステップ

| 項目                   | 改善前の状態 (Before)            | 改善後の状態 (After)               |
| :--------------------- | :------------------------------- | :--------------------------------- |
| **IAM 権限**           | AdministratorAccess (高リスク)   | 最小権限ポリシー (セキュア)        |
| **Terraform 状態管理** | ローカルファイル (個人作業のみ)  | S3 による中央管理 (チーム開発対応) |
| **データ保護**         | 平文、バックアップなし           | 暗号化、バージョニング有効         |
| **運用リスク**         | 属人化、状態ファイルの喪失リスク | 再現性担保、競合防止（ロック機能） |

この強固な基盤の上で、いよいよアプリケーションの本格的な機能開発に着手します。

- **Immediate:** **Task-002 (Hello World Lambda 実装)** へ進み、Go 言語でのビジネスロジック実装を開始します。
- **Next:** **Task-003 (イベント作成 API 実装)** へと進み、アプリケーションのコア機能開発を加速させます。

プロジェクトは、安心して全力で機能開発に集中できる、理想的なスタート地点に立ちました。
